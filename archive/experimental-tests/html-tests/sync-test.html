<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distract Me Not - Sync Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .result {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.green { background: #28a745; }
        .status-indicator.red { background: #dc3545; }
        .status-indicator.yellow { background: #ffc107; }
    </style>
</head>
<body>
    <h1>üîÑ Distract Me Not - Sync Testing Tool</h1>
    <p>This tool helps diagnose and test the Chrome extension sync functionality.</p>
    
    <div class="test-section">
        <h3>üìä Sync Status</h3>
        <p>Check if sync is available and working properly.</p>
        <button class="test-button" onclick="checkSyncStatus()">Check Sync Status</button>
        <div id="sync-status-result" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>üß™ Sync Functionality Test</h3>
        <p>Test reading and writing data to sync storage.</p>
        <button class="test-button" onclick="testSyncFunctionality()">Run Sync Test</button>
        <div id="sync-test-result" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>üîç Problem Diagnosis</h3>
        <p>Scan for common sync issues and problems.</p>
        <button class="test-button" onclick="runDiagnosis()">Run Diagnosis</button>
        <div id="diagnosis-result" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>üîÑ Force Sync Operations</h3>
        <p>Force sync all local data or clear sync storage.</p>
        <button class="test-button" onclick="forceSyncAllData()">Force Sync All Data</button>
        <button class="test-button" onclick="clearSyncStorage()" style="background: #dc3545;">Clear Sync Storage</button>
        <div id="force-sync-result" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù Manual Sync Test</h3>
        <p>Manually test saving and loading specific data.</p>
        <input type="text" id="test-key" placeholder="Test key (e.g., testData)" style="padding: 8px; margin: 5px;">
        <input type="text" id="test-value" placeholder="Test value" style="padding: 8px; margin: 5px;">
        <br>
        <button class="test-button" onclick="saveTestData()">Save to Sync</button>
        <button class="test-button" onclick="loadTestData()">Load from Sync</button>
        <button class="test-button" onclick="deleteTestData()">Delete Test Data</button>
        <div id="manual-test-result" class="result" style="display: none;"></div>
    </div>

    <script>
        // Utility functions
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = content;
        }

        function formatResult(data) {
            return JSON.stringify(data, null, 2);
        }

        // Test functions
        async function checkSyncStatus() {
            try {
                showResult('sync-status-result', 'Checking sync status...', 'info');
                
                // Check if chrome.storage.sync is available
                if (!chrome || !chrome.storage || !chrome.storage.sync) {
                    throw new Error('Chrome sync storage API not available');
                }

                // Test basic sync access
                await chrome.storage.sync.get('test');
                
                // Get quota info
                const bytesInUse = await chrome.storage.sync.getBytesInUse();
                const maxItems = chrome.storage.sync.MAX_ITEMS || 512;
                const maxBytes = chrome.storage.sync.QUOTA_BYTES || 102400;
                
                const status = {
                    syncAvailable: true,
                    bytesInUse,
                    maxItems,
                    maxBytes,
                    usagePercentage: ((bytesInUse / maxBytes) * 100).toFixed(2),
                    browser: navigator.userAgent
                };
                
                showResult('sync-status-result', formatResult(status), 'success');
            } catch (error) {
                showResult('sync-status-result', `Error: ${error.message}`, 'error');
            }
        }

        async function testSyncFunctionality() {
            try {
                showResult('sync-test-result', 'Running sync functionality test...', 'info');
                
                const testKey = 'dmn_sync_test_' + Date.now();
                const testData = {
                    timestamp: Date.now(),
                    testValue: 'Hello Sync!',
                    randomData: Math.random()
                };
                
                const startTime = Date.now();
                
                // Test 1: Save data
                await chrome.storage.sync.set({ [testKey]: testData });
                
                // Test 2: Read data back
                const result = await chrome.storage.sync.get(testKey);
                
                // Test 3: Verify data integrity
                const retrievedData = result[testKey];
                const dataMatches = JSON.stringify(testData) === JSON.stringify(retrievedData);
                
                // Test 4: Cleanup
                await chrome.storage.sync.remove(testKey);
                
                const duration = Date.now() - startTime;
                
                const testResult = {
                    success: dataMatches,
                    duration: `${duration}ms`,
                    testData,
                    retrievedData,
                    dataIntegrity: dataMatches ? 'PASS' : 'FAIL'
                };
                
                showResult('sync-test-result', formatResult(testResult), dataMatches ? 'success' : 'error');
            } catch (error) {
                showResult('sync-test-result', `Error: ${error.message}`, 'error');
            }
        }

        async function runDiagnosis() {
            try {
                showResult('diagnosis-result', 'Running sync diagnosis...', 'info');
                
                const problems = [];
                const recommendations = [];
                
                // Check quota usage
                const bytesInUse = await chrome.storage.sync.getBytesInUse();
                const maxBytes = chrome.storage.sync.QUOTA_BYTES || 102400;
                const usagePercentage = (bytesInUse / maxBytes) * 100;
                
                if (usagePercentage > 80) {
                    problems.push(`High quota usage: ${usagePercentage.toFixed(2)}%`);
                    recommendations.push('Consider cleaning up old or unnecessary synced data');
                }
                
                // Check for large items
                const allData = await chrome.storage.sync.get();
                const largeItems = [];
                
                for (const [key, value] of Object.entries(allData)) {
                    const size = JSON.stringify(value).length;
                    if (size > 8192) { // Chrome sync item limit
                        largeItems.push({ key, size });
                    }
                }
                
                if (largeItems.length > 0) {
                    problems.push(`Found ${largeItems.length} oversized items`);
                    recommendations.push('Split large data items into smaller chunks');
                }
                
                // Check item count
                const itemCount = Object.keys(allData).length;
                const maxItems = chrome.storage.sync.MAX_ITEMS || 512;
                
                if (itemCount > maxItems * 0.8) {
                    problems.push(`High item count: ${itemCount}/${maxItems}`);
                    recommendations.push('Consider consolidating related data items');
                }
                
                const diagnosis = {
                    timestamp: new Date().toISOString(),
                    problems: problems.length > 0 ? problems : ['No problems detected'],
                    recommendations: recommendations.length > 0 ? recommendations : ['No recommendations'],
                    stats: {
                        bytesInUse,
                        usagePercentage: usagePercentage.toFixed(2),
                        itemCount,
                        largeItems: largeItems.length
                    }
                };
                
                showResult('diagnosis-result', formatResult(diagnosis), problems.length > 0 ? 'warning' : 'success');
            } catch (error) {
                showResult('diagnosis-result', `Error: ${error.message}`, 'error');
            }
        }

        async function forceSyncAllData() {
            try {
                showResult('force-sync-result', 'Force syncing all data...', 'info');
                
                // This is a simplified version - in the actual extension,
                // this would trigger the full sync mechanism
                const localData = await chrome.storage.local.get();
                const syncableKeys = Object.keys(localData).filter(key => 
                    !key.startsWith('_') && // Skip private keys
                    key !== 'lastSyncCheck' && // Skip sync metadata
                    key !== 'installId' // Skip installation-specific data
                );
                
                const syncData = {};
                syncableKeys.forEach(key => {
                    syncData[key] = localData[key];
                });
                
                await chrome.storage.sync.set(syncData);
                
                const result = {
                    message: 'Data force synced successfully',
                    syncedKeys: syncableKeys,
                    syncedCount: syncableKeys.length
                };
                
                showResult('force-sync-result', formatResult(result), 'success');
            } catch (error) {
                showResult('force-sync-result', `Error: ${error.message}`, 'error');
            }
        }

        async function clearSyncStorage() {
            if (!confirm('Are you sure you want to clear all sync storage? This cannot be undone.')) {
                return;
            }
            
            try {
                showResult('force-sync-result', 'Clearing sync storage...', 'info');
                
                await chrome.storage.sync.clear();
                
                const result = {
                    message: 'Sync storage cleared successfully',
                    timestamp: new Date().toISOString()
                };
                
                showResult('force-sync-result', formatResult(result), 'success');
            } catch (error) {
                showResult('force-sync-result', `Error: ${error.message}`, 'error');
            }
        }

        async function saveTestData() {
            try {
                const key = document.getElementById('test-key').value || 'testData';
                const value = document.getElementById('test-value').value || 'test value';
                
                showResult('manual-test-result', `Saving ${key}...`, 'info');
                
                await chrome.storage.sync.set({ [key]: value });
                
                showResult('manual-test-result', `Successfully saved: ${key} = ${value}`, 'success');
            } catch (error) {
                showResult('manual-test-result', `Error: ${error.message}`, 'error');
            }
        }

        async function loadTestData() {
            try {
                const key = document.getElementById('test-key').value || 'testData';
                
                showResult('manual-test-result', `Loading ${key}...`, 'info');
                
                const result = await chrome.storage.sync.get(key);
                
                if (result[key] !== undefined) {
                    showResult('manual-test-result', `Loaded: ${key} = ${result[key]}`, 'success');
                } else {
                    showResult('manual-test-result', `Key '${key}' not found in sync storage`, 'warning');
                }
            } catch (error) {
                showResult('manual-test-result', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteTestData() {
            try {
                const key = document.getElementById('test-key').value || 'testData';
                
                showResult('manual-test-result', `Deleting ${key}...`, 'info');
                
                await chrome.storage.sync.remove(key);
                
                showResult('manual-test-result', `Successfully deleted: ${key}`, 'success');
            } catch (error) {
                showResult('manual-test-result', `Error: ${error.message}`, 'error');
            }
        }

        // Check if we're running in an extension context
        if (!chrome || !chrome.storage) {
            document.body.innerHTML = `
                <h1>‚ö†Ô∏è Chrome Extension Context Required</h1>
                <p>This sync testing tool must be run within a Chrome extension context.</p>
                <p>To use this tool:</p>
                <ol>
                    <li>Load the Distract Me Not extension</li>
                    <li>Open the extension popup or settings page</li>
                    <li>Open the browser developer tools (F12)</li>
                    <li>Navigate to this page from within the extension context</li>
                </ol>
            `;
        } else {
            console.log('üîÑ Sync testing tool loaded successfully');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Distract Me Not - Quick Sync Status</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
    }
    h1, h2 {
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 20px;
    }
    button {
      background-color: #0078d7;
      border: none;
      color: white;
      padding: 8px 16px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background-color: #0063b1;
    }
    .success {
      color: #008000;
      font-weight: bold;
    }
    .error {
      color: #ff0000;
      font-weight: bold;
    }
    .warning {
      color: #ff8c00;
      font-weight: bold;
    }
    pre {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      white-space: pre-wrap;
      overflow-x: auto;
    }
    #status {
      font-size: 16px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <h1>Distract Me Not - Quick Sync Status</h1>
  
  <div class="card">
    <h2>Current Status</h2>
    <div id="status">Checking sync status...</div>
    <div id="error" class="error" style="display:none;"></div>
    <div id="counts" style="margin-top: 15px;"></div>
  </div>
  
  <div class="card">
    <h2>Quick Actions</h2>
    <button id="pushBtn">Push Settings to Sync</button>
    <button id="pullBtn">Pull Settings from Sync</button>
    <button id="reloadBtn">Reload Extension</button>
  </div>
  
  <div class="card">
    <h2>Raw Data</h2>
    <div style="margin-bottom: 10px;">
      <button id="showSyncBtn">Show Sync Storage</button>
      <button id="showLocalBtn">Show Local Storage</button>
      <button id="showSwBtn">Show Service Worker State</button>
    </div>
    <pre id="rawData" style="display:none;"></pre>
  </div>
  
  <script>
    // Simplified status check
    async function checkStatus() {
      try {
        document.getElementById('status').textContent = 'Checking sync status...';
        document.getElementById('error').style.display = 'none';
        document.getElementById('counts').innerHTML = '';
        
        // Test sync storage
        const testKey = 'quick_test_' + Date.now();
        await chrome.storage.sync.set({ [testKey]: true });
        const result = await chrome.storage.sync.get(testKey);
        const syncWorking = result[testKey] === true;
        await chrome.storage.sync.remove(testKey);
        
        // Get settings
        const syncData = await chrome.storage.sync.get(['blacklist', 'whitelist']);
        const localData = await chrome.storage.local.get(['blacklist', 'whitelist']);
        
        // Get service worker state
        let swState = 'Unknown';
        let swDenyList = [];
        let swAllowList = [];
        try {
          const swResponse = await new Promise(resolve => {
            chrome.runtime.sendMessage({ message: 'getCurrentSettings' }, response => {
              resolve(response || {});
            });
          });
          
          if (swResponse && swResponse.response) {
            swState = 'Active';
            swDenyList = swResponse.response.blacklist || [];
            swAllowList = swResponse.response.whitelist || [];
          } else {
            swState = 'Inactive or error';
          }
        } catch (e) {
          swState = 'Error: ' + e.message;
        }
        
        // Set status
        let statusHtml = '';
        const syncDenyListCount = syncData.blacklist ? syncData.blacklist.length : 0;
        const syncAllowListCount = syncData.whitelist ? syncData.whitelist.length : 0;
        const localDenyListCount = localData.blacklist ? localData.blacklist.length : 0;
        const localAllowListCount = localData.whitelist ? localData.whitelist.length : 0;
        const swDenyListCount = swDenyList.length;
        const swAllowListCount = swAllowList.length;
        
        if (syncWorking) {
          statusHtml = '<span class="success">&#10003; Sync API is working correctly</span>';
        } else {
          statusHtml = '<span class="error">&#10007; Sync API is not working</span>';
        }
        
        if (swState === 'Active') {
          statusHtml += '<br><span class="success">&#10003; Service Worker is active</span>';
        } else {
          statusHtml += '<br><span class="error">&#10007; Service Worker issues: ' + swState + '</span>';
        }
        
        if (syncDenyListCount === swDenyListCount && syncAllowListCount === swAllowListCount) {
          statusHtml += '<br><span class="success">&#10003; Sync storage and Service Worker are in sync</span>';
        } else {
          statusHtml += '<br><span class="warning">&#9888; Sync storage and Service Worker are out of sync</span>';
        }
        
        if (localDenyListCount === swDenyListCount && localAllowListCount === swAllowListCount) {
          statusHtml += '<br><span class="success">&#10003; Local storage and Service Worker are in sync</span>';
        } else {
          statusHtml += '<br><span class="warning">&#9888; Local storage and Service Worker are out of sync</span>';
        }
        
        document.getElementById('status').innerHTML = statusHtml;
        
        // Show counts
        let countsHtml = `
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="background-color: #f0f0f0;">
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Data Source</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Deny List</th>
              <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Allow List</th>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #ddd;">Sync Storage</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${syncDenyListCount} items</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${syncAllowListCount} items</td>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #ddd;">Local Storage</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${localDenyListCount} items</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${localAllowListCount} items</td>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #ddd;">Service Worker</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${swDenyListCount} items</td>
              <td style="padding: 8px; border: 1px solid #ddd;">${swAllowListCount} items</td>
            </tr>
          </table>
          <div style="margin-top: 10px; font-size: 12px; color: #666;">
            Last checked: ${new Date().toLocaleTimeString()}
          </div>
        `;
        
        document.getElementById('counts').innerHTML = countsHtml;
        
      } catch (error) {
        document.getElementById('error').textContent = 'Error checking status: ' + error.message;
        document.getElementById('error').style.display = 'block';
        console.error('Status check error:', error);
      }
    }
    
    // Push settings to sync
    async function pushToSync() {
      try {
        document.getElementById('status').textContent = 'Pushing settings to sync...';
        
        // Get local data
        const localData = await chrome.storage.local.get(['blacklist', 'whitelist', 'blacklistKeywords', 'whitelistKeywords', 'mode', 'framesType']);
        
        // Push to sync
        await chrome.storage.sync.set({
          blacklist: localData.blacklist || [],
          whitelist: localData.whitelist || [],
          blacklistKeywords: localData.blacklistKeywords || [],
          whitelistKeywords: localData.whitelistKeywords || [],
          mode: localData.mode || 'denylist',
          framesType: localData.framesType || ['main_frame']
        });
        
        // Update service worker
        chrome.runtime.sendMessage({ message: 'updateRules' });
        
        // Update status
        checkStatus();
      } catch (error) {
        document.getElementById('error').textContent = 'Error pushing to sync: ' + error.message;
        document.getElementById('error').style.display = 'block';
        console.error('Push error:', error);
      }
    }
    
    // Pull settings from sync
    async function pullFromSync() {
      try {
        document.getElementById('status').textContent = 'Pulling settings from sync...';
        
        // Get sync data
        const syncData = await chrome.storage.sync.get(['blacklist', 'whitelist', 'blacklistKeywords', 'whitelistKeywords', 'mode', 'framesType']);
        
        // Save to local
        await chrome.storage.local.set({
          blacklist: syncData.blacklist || [],
          whitelist: syncData.whitelist || [],
          blacklistKeywords: syncData.blacklistKeywords || [],
          whitelistKeywords: syncData.whitelistKeywords || [],
          mode: syncData.mode || 'denylist',
          framesType: syncData.framesType || ['main_frame']
        });
        
        // Update service worker
        chrome.runtime.sendMessage({ message: 'updateRules' });
        
        // Update status
        checkStatus();
      } catch (error) {
        document.getElementById('error').textContent = 'Error pulling from sync: ' + error.message;
        document.getElementById('error').style.display = 'block';
        console.error('Pull error:', error);
      }
    }
    
    // Show storage data
    async function showSyncStorage() {
      try {
        const data = await chrome.storage.sync.get(null);
        document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
        document.getElementById('rawData').style.display = 'block';
      } catch (error) {
        document.getElementById('rawData').textContent = 'Error: ' + error.message;
        document.getElementById('rawData').style.display = 'block';
      }
    }
    
    async function showLocalStorage() {
      try {
        const data = await chrome.storage.local.get(null);
        document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
        document.getElementById('rawData').style.display = 'block';
      } catch (error) {
        document.getElementById('rawData').textContent = 'Error: ' + error.message;
        document.getElementById('rawData').style.display = 'block';
      }
    }
    
    async function showServiceWorkerState() {
      try {
        const response = await new Promise(resolve => {
          chrome.runtime.sendMessage({ message: 'getCurrentSettings' }, response => {
            resolve(response || {});
          });
        });
        document.getElementById('rawData').textContent = JSON.stringify(response, null, 2);
        document.getElementById('rawData').style.display = 'block';
      } catch (error) {
        document.getElementById('rawData').textContent = 'Error: ' + error.message;
        document.getElementById('rawData').style.display = 'block';
      }
    }
    
    // Set up event listeners
    document.getElementById('pushBtn').addEventListener('click', pushToSync);
    document.getElementById('pullBtn').addEventListener('click', pullFromSync);
    document.getElementById('reloadBtn').addEventListener('click', () => {
      chrome.runtime.reload();
      setTimeout(checkStatus, 1000);
    });
    document.getElementById('showSyncBtn').addEventListener('click', showSyncStorage);
    document.getElementById('showLocalBtn').addEventListener('click', showLocalStorage);
    document.getElementById('showSwBtn').addEventListener('click', showServiceWorkerState);
    
    // Run initial check
    checkStatus();
  </script>
</body>
</html>
